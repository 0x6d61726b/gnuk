<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>ChibiOS/RT: Porting ChibiOS/RT for Dummies</title>
<link href="custom.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<table style="text-align: center; width: 100%;" border="0"
 cellpadding="2" cellspacing="2">
  <tbody>
    <tr>
      <td style="width: 80px;"><img alt="ChibiOS/RT Logo" src="logo_small.png"></td>
      <td><big><big>ChibiOS/RT</big></big><br><br>Architecture - Reference Manual - Guides</td>
      <td style="width: 80px;"></td>
    </tr>
  </tbody>
</table>
<hr size="1">
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="main.html">ChibiOS/RT</a>      </li>
      <li><a class="el" href="articles.html">Articles and Code Samples</a>      </li>
      <li><a class="el" href="page_kb.html">Knowledge Base</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>Porting ChibiOS/RT for Dummies </h1>  </div>
</div>
<div class="contents">
<p>Porting the operating system on a new platform is one of the most common tasks. The difficulty can range from easy to very difficult depending on several factors.<br/>
 We can divide in problem in several classes of progressively increasing difficulty:</p>
<ul>
<li><a class="el" href="article_portguide.html#port_board">Porting the OS to a new board</a></li>
<li><a class="el" href="article_portguide.html#port_family">Porting the OS to a closely related microcontroller</a></li>
<li><a class="el" href="article_portguide.html#port_chip">Porting the OS to another microcontroller using the same core</a></li>
<li><a class="el" href="article_portguide.html#port_core">Porting the OS to a whole new architecture</a></li>
</ul>
<p>Another kind of port type is porting to another compiler and this is an added complexity level on the above classes. The kernel itself is portable but the port-specific code usually contains compiler specific extensions to the C language and the asm files syntax is almost never compatible.</p>
<h2><a class="anchor" id="port_board"></a>
Porting the OS to a new board</h2>
<p>This is the easiest port type, the scenario is that the specific microcontroller is already supported and a demo exists. This scenario also applies when porting the OS on a custom hardware using a supported microcontroller. This task can be easily performed with the following steps:</p>
<ol type="1">
<li>Create a new directory under ./boards and copy inside the board files from another board using the same microcontroller.</li>
<li>Customize the board files:<ul>
<li><code>board.h</code> This file contains the I/O pins setup for the uC, it may also contain other board-dependent settings, as example, the clock frequency. Customize this file depending on your target hardware.</li>
<li><code>board.c</code> This file contains the initialization code, it is possible you just need to customize <code>board.h</code> and not this file. If you have some hardware specific initialization code then put it here.</li>
</ul>
</li>
<li>Create a new directory under the ChibiOS/RT installation directory: <code>./projects/<em>&lt;my_app_name&gt;</em></code></li>
<li>Copy an existing demo code under the newly created directory.</li>
<li>Customize the demo:<ul>
<li><code>Makefile</code> You may edit this file in order to remove the test related sources and/or add you application source files.</li>
<li><code>main.c</code> It contains the demo simple code, clean it and write your own <code>main()</code> function here, use this file just as a template.</li>
</ul>
</li>
<li>Compile your application and debug.</li>
</ol>
<h2><a class="anchor" id="port_family"></a>
Porting the OS to a closely related microcontroller</h2>
<p>In this scenario all the above steps are required but an analysis must be performed to evaluate the differences between from the supported micro and the target micro. Often the micros just differ for the memory area sizes and a change to the linker script is enough (the file is usually named <code>ch.ld</code>). Chips having more or less peripherals, everything else being the same or compatible are not a problem also as long the timer and the serial peripherals used by the port do not change.<br/>
 If there are differences in the internal peripherals, as example non compatible interrupt controllers (this happens in the LPC2000 family) or differences in UARTS, timers etc then the port falls in the following category.</p>
<h2><a class="anchor" id="port_chip"></a>
Porting the OS to another microcontroller using the same core</h2>
<p>This kind of port is required when a target microcontroller has the same core (a common example: ARM7) of a supported microcontroller but has differences in the internal peripherals.<br/>
 If this is your case proceed as follow:</p>
<ol type="1">
<li>Create a new directory under <code><code></code>./os/io/platforms</code> and name it with the microcontroller name (or family name).<br/>
 In case of the ARM-based microcontroller you also need to create a equally named directory under <code><code></code>./os/ports/<em>&lt;compiler&gt;</em>/<em>&lt;arch&gt;</em></code> and put there the microcontroller related files such as the vectors table, see the existing ports as example.</li>
<li>Copy into the newly created directory the most closely related existing chip port or the naked template files from <code><code></code>./os/io/templates</code>.</li>
<li>Work out the differences in the drivers or implement them if you started from the templates.</li>
<li>Edit/create the documentation file <code><code>platform.dox</code></code>, this is required if you want to regenerate this documentation including your work.</li>
</ol>
<p>Usually this kind of port just requires a serial driver (and those are very similar each other) and some code for the interrupt controller (this one can be part of the core port, as example the Cortex-M3 has this as standard part of the core).<br/>
 When the chip port is completed created your application as seen in the previous sections.</p>
<h2><a class="anchor" id="port_core"></a>
Porting the OS to a whole new architecture</h2>
<p>This is the hardest scenario, the time required by core ports depends strongly by the target architecture complexity and the level of support you need for the architecture specific features.<br/>
 As a reference, the MSP430 port took me 2 hours and it worked at the first run, it can be a reference for simple architectures, the ARM Cortex-M3 was painful instead, the architecture enforces you to implement things in a very specific way and I spent 2 week to go through all the documentation and figure out the correct way to implement the port (you can see that the preemption context switch is done in a very peculiar way because the exceptions architecture).<br/>
 One thing is sure, port an OS to a new architecture is not an easy task and if you have the required experience for such an effort then probably you don't need any advice from me. Just follow the directory patterns and fill the OS template files, the hardest part is decide the correct and efficient way to implement the context switching. </p>
</div>
<hr size="1"><address style="text-align: right;"><small>
Generated on Sun Oct 24 2010 09:40:45 for ChibiOS/RT by&nbsp;<a href="http://www.doxygen.org/index.html"><img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.7.1</small></address>
</body>
</html>
